<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasonic Chat</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height:100vh; display:flex; justify-content:center; align-items:center; padding:20px;
        }
        .app {
            background:white; border-radius:20px; width:100%; max-width:480px;
            height:90vh; max-height:700px; display:flex; flex-direction:column;
            box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden;
        }
        h1 { background:linear-gradient(135deg,#667eea,#764ba2); color:white;
             padding:16px; text-align:center; font-size:20px; }
        .statusbar { display:flex; justify-content:space-around; padding:10px;
                     background:#f5f5f5; border-bottom:1px solid #ddd; font-size:12px; align-items:center;}
        .dot { width:9px; height:9px; border-radius:50%; background:#ccc; display:inline-block; margin-right:5px; }
        .dot.on { background:#28a745; }
        .messages { flex:1; overflow-y:auto; padding:16px; background:#f8f9fa; }
        .bubble { max-width:72%; padding:10px 14px; border-radius:16px; margin-bottom:10px; }
        .sent { background:linear-gradient(135deg,#667eea,#764ba2); color:white; margin-left:auto; }
        .received { background:white; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
        .sys { text-align:center; color:#999; font-size:12px; margin:8px 0; }
        .debug { height:120px; overflow-y:auto; background:#111; color:#0f0;
                 font-family:monospace; font-size:10px; padding:8px; border-top:1px solid #333; }
        .inputbar { display:flex; gap:8px; padding:12px; background:white; border-top:1px solid #eee; }
        input { flex:1; padding:10px 14px; border:2px solid #eee; border-radius:20px; outline:none; font-size:14px; }
        input:focus { border-color:#667eea; }
        button.send { background:linear-gradient(135deg,#667eea,#764ba2); color:white;
                      border:none; border-radius:50%; width:42px; height:42px; cursor:pointer; font-size:18px; }
    </style>
</head>
<body>
<div class="app">
    <h1>ðŸ’¬ Ultrasonic Chat</h1>
    <div class="statusbar">
        <span><span class="dot" id="dTx"></span>TX</span>
        <span><span class="dot" id="dRx"></span>RX</span>
        <span id="sig">Ready</span>
    </div>
    <div class="messages" id="msgs">
        <div class="sys">Open on two devices â€” Chrome only, max volume!</div>
    </div>
    <div class="debug" id="dbg"></div>
    <div class="inputbar">
        <input id="txt" placeholder="Type message..." maxlength="30">
        <button class="send" onclick="send()">ðŸ“¤</button>
    </div>
</div>
<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SR       = 48000;
const CHARS    = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 .,!?';
const BASE     = 18000;
const STEP     = 15;          // Hz per character
const TONE_MS  = 250;         // tone duration
const GAP_MS   = 80;          // silence between tones
const MSG_MS   = 600;         // silence = end of message

// Detection: measure RMS over a rolling window
// When RMS crosses RMS_ON we're in a tone; when it drops below RMS_OFF we're in silence
const RMS_WIN  = 512;         // samples for RMS measurement (~10ms)
const RMS_ON   = 0.004;       // threshold to detect tone start
const RMS_OFF  = 0.002;       // threshold to detect silence

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ctx, analyser;
let rxChars = [], lastRxTime = 0;
let inTone = false;
let toneSamples = [];         // accumulate samples while in tone
let rmsBuffer = new Float32Array(RMS_WIN);
let rmsPos = 0;

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(s) {
    const d = document.getElementById('dbg');
    d.textContent = new Date().toLocaleTimeString('en',{hour12:false})+' '+s+'\n'+d.textContent;
    d.textContent = d.textContent.split('\n').slice(0,25).join('\n');
}

// â”€â”€ Encoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function c2f(c) { const i=CHARS.indexOf(c.toUpperCase()); return i>=0?BASE+i*STEP:null; }
function f2c(f) {
    const i = Math.round((f-BASE)/STEP);
    if (i<0||i>=CHARS.length) return null;
    if (Math.abs(f-(BASE+i*STEP)) > STEP*0.45) return null;
    return CHARS[i];
}

// â”€â”€ Goertzel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goertzel(buf, f) {
    const w = 2*Math.PI*f/SR, c = 2*Math.cos(w);
    let s1=0, s2=0;
    for (let i=0;i<buf.length;i++) { const s=buf[i]+c*s1-s2; s2=s1; s1=s; }
    return s1*s1 + s2*s2 - s1*s2*c;
}

// Find best character in a buffer of samples
function detectChar(buf) {
    let best=0, bestF=0;
    for (let i=0;i<CHARS.length;i++) {
        const f = BASE+i*STEP;
        const p = goertzel(buf, f);
        if (p>best) { best=p; bestF=f; }
    }
    // SNR: compare best to average
    let total=0;
    for (let i=0;i<CHARS.length;i++) total+=goertzel(buf, BASE+i*STEP);
    const avg = total/CHARS.length;
    const snr = best/avg;
    return { char: f2c(bestF), freq: bestF, snr };
}

// â”€â”€ TX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send() {
    const raw = document.getElementById('txt').value.toUpperCase().trim();
    document.getElementById('txt').value = '';
    if (!raw||!ctx) return;
    const text = raw.split('').filter(c=>CHARS.includes(c)).join('');
    if (!text) return;

    log('TX: '+text);
    document.getElementById('dTx').classList.add('on');

    const tS = Math.round(SR*TONE_MS/1000);
    const gS = Math.round(SR*GAP_MS/1000);
    const buf = ctx.createBuffer(1, text.length*(tS+gS), SR);
    const d   = buf.getChannelData(0);
    let pos = 0;

    for (const c of text) {
        const f = c2f(c), w = 2*Math.PI*f/SR;
        for (let i=0;i<tS;i++) {
            const env = 0.5*(1-Math.cos(2*Math.PI*i/(tS-1))); // Hanning
            d[pos++] = Math.sin(w*i)*0.8*env;
        }
        for (let i=0;i<gS;i++) d[pos++]=0;
    }

    const src = ctx.createBufferSource();
    src.buffer = buf;
    src.connect(ctx.destination);
    src.start();
    src.onended = ()=>document.getElementById('dTx').classList.remove('on');
    addBubble(text,'sent');
}

// â”€â”€ RX via ScriptProcessor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRx() {
    const proc = ctx.createScriptProcessor(512, 1, 1);
    analyser.connect(proc);
    proc.connect(ctx.destination);

    proc.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);

        // Update rolling RMS buffer
        for (let i=0;i<input.length;i++) {
            rmsBuffer[rmsPos % RMS_WIN] = input[i]*input[i];
            rmsPos++;
        }

        // Compute RMS
        let sum=0;
        for (let i=0;i<RMS_WIN;i++) sum+=rmsBuffer[i];
        const rms = Math.sqrt(sum/RMS_WIN);

        document.getElementById('sig').textContent = 'RMS: '+rms.toFixed(4);

        const now = Date.now();

        if (!inTone && rms > RMS_ON) {
            // â”€â”€ Rising edge: silence â†’ tone â”€â”€
            inTone = true;
            toneSamples = [];
            log('â–² Tone start (rms='+rms.toFixed(4)+')');
        }

        if (inTone) {
            // Accumulate samples
            for (let i=0;i<input.length;i++) toneSamples.push(input[i]);

            if (rms < RMS_OFF) {
                // â”€â”€ Falling edge: tone â†’ silence â”€â”€
                inTone = false;
                log('â–¼ Tone end ('+toneSamples.length+' samples)');

                // Only analyse if we have enough samples (at least 50ms)
                if (toneSamples.length > SR*0.05) {
                    // Use middle 60% of samples (skip transitions)
                    const start = Math.floor(toneSamples.length*0.2);
                    const end   = Math.floor(toneSamples.length*0.8);
                    const slice = toneSamples.slice(start, end);

                    const result = detectChar(slice);
                    log('  â†’ '+JSON.stringify(result));

                    if (result.char && result.snr > 3.0) {
                        rxChars.push(result.char);
                        lastRxTime = now;
                        log('âœ“ CHAR: '+result.char+' SNR='+result.snr.toFixed(1));
                        document.getElementById('dRx').classList.add('on');
                        setTimeout(()=>document.getElementById('dRx').classList.remove('on'),150);
                    }
                }
                toneSamples = [];
            }
        }

        // Flush message after silence
        if (rxChars.length>0 && now-lastRxTime > MSG_MS) {
            const msg = rxChars.join('');
            log('MSG: '+msg);
            addBubble(msg,'received');
            rxChars = [];
        }
    };
    log('RX ready (RMS_ON='+RMS_ON+')');
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBubble(text, cls) {
    const d = document.createElement('div');
    d.className='bubble '+cls;
    d.textContent=text;
    const m=document.getElementById('msgs');
    m.appendChild(d);
    m.scrollTop=m.scrollHeight;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    ctx = new AudioContext({sampleRate:SR});
    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}
    });
    analyser = ctx.createAnalyser();
    ctx.createMediaStreamSource(stream).connect(analyser);
    log('Audio OK SR='+ctx.sampleRate);
    startRx();
}

window.onload = () => {
    const btn = document.createElement('button');
    btn.textContent='ðŸŽ¤ Start Chat';
    Object.assign(btn.style,{
        position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',
        padding:'20px 48px',fontSize:'22px',fontWeight:'700',
        background:'linear-gradient(135deg,#667eea,#764ba2)',
        color:'white',border:'none',borderRadius:'32px',
        cursor:'pointer',boxShadow:'0 12px 40px rgba(0,0,0,0.4)',zIndex:'9999'
    });
    btn.onclick=()=>{init();btn.remove();};
    document.body.appendChild(btn);
    document.getElementById('txt').onkeydown=e=>{if(e.key==='Enter')send();};
};
</script>
</body>
</html>
