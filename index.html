<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasonic Chat</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height:100vh; display:flex; justify-content:center; align-items:center; padding:20px;
        }
        .app {
            background:white; border-radius:20px; width:100%; max-width:480px;
            height:90vh; max-height:700px; display:flex; flex-direction:column;
            box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden;
        }
        h1 { background:linear-gradient(135deg,#667eea,#764ba2); color:white;
             padding:16px; text-align:center; font-size:20px; margin:0; }
        .statusbar { display:flex; justify-content:space-around; padding:10px;
                     background:#f5f5f5; border-bottom:1px solid #ddd; font-size:12px; align-items:center; }
        .dot { width:9px; height:9px; border-radius:50%; background:#ccc;
               display:inline-block; margin-right:5px; transition:background .2s; }
        .dot.on   { background:#28a745; }
        .dot.err  { background:#dc3545; }
        .dot.busy { background:#ffc107; animation: blink 0.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .messages { flex:1; overflow-y:auto; padding:16px; background:#f8f9fa; }
        .bubble { max-width:75%; padding:10px 14px; border-radius:16px;
                  margin-bottom:10px; word-break:break-word; line-height:1.4; }
        .sent     { background:linear-gradient(135deg,#667eea,#764ba2); color:white; margin-left:auto; }
        .received { background:white; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
        .sys      { text-align:center; color:#999; font-size:12px; margin:6px 0; font-style:italic; }
        .debug { height:110px; overflow-y:auto; background:#111; color:#0f0;
                 font-family:monospace; font-size:10px; padding:8px; border-top:1px solid #333; }
        .inputbar { display:flex; gap:8px; padding:12px; background:white; border-top:1px solid #eee; }
        input { flex:1; padding:10px 14px; border:2px solid #eee; border-radius:20px;
                outline:none; font-size:14px; }
        input:focus { border-color:#667eea; }
        input:disabled { background:#f5f5f5; }
        .btn-send {
            background:linear-gradient(135deg,#667eea,#764ba2); color:white;
            border:none; border-radius:50%; width:42px; height:42px;
            cursor:pointer; font-size:18px; flex-shrink:0;
        }
        .btn-send:disabled { opacity:0.4; cursor:not-allowed; }
        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.55);
            display:flex; justify-content:center; align-items:center; z-index:999;
        }
        .overlay-box {
            background:white; border-radius:20px; padding:32px 28px;
            text-align:center; max-width:340px; width:90%;
        }
        .overlay-box h2 { margin-bottom:10px; }
        .overlay-box p  { color:#666; font-size:14px; line-height:1.6; margin-bottom:20px; }
        .overlay-box button {
            background:linear-gradient(135deg,#667eea,#764ba2); color:white;
            border:none; border-radius:25px; padding:14px 36px;
            font-size:17px; font-weight:600; cursor:pointer;
        }
    </style>
</head>
<body>
<div class="app">
    <h1>ðŸ’¬ Ultrasonic Chat</h1>
    <div class="statusbar">
        <span><span class="dot busy" id="dTx"></span>TX</span>
        <span><span class="dot busy" id="dRx"></span>RX</span>
        <span id="stText" style="font-size:11px;color:#888;">Loading...</span>
    </div>
    <div class="messages" id="msgs">
        <div class="sys" id="ph">Initializing quiet.jsâ€¦</div>
    </div>
    <div class="debug" id="dbg"></div>
    <div class="inputbar">
        <input id="txt" placeholder="Loadingâ€¦" disabled maxlength="200">
        <button class="btn-send" id="btnSend" disabled onclick="sendMsg()">ðŸ“¤</button>
    </div>
</div>

<div class="overlay" id="overlay">
    <div class="overlay-box">
        <h2>ðŸ”Š Ultrasonic Chat</h2>
        <p>Sends text silently between devices using ~19kHz ultrasonic sound.<br><br>
           <strong>Chrome only</strong> (Firefox cannot receive ultrasonic).<br>
           Max speaker volume on transmitting device.</p>
        <button onclick="startApp()">ðŸŽ¤ Start Chat</button>
    </div>
</div>

<!-- quiet.js â€” load from GitHub Pages (correct file order) -->
<script src="https://quiet.github.io/quiet-js/quiet.js"></script>
<script async src="https://quiet.github.io/quiet-js/quiet-emscripten.js"></script>

<script>
// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(s) {
    const d = document.getElementById('dbg');
    const t = new Date().toLocaleTimeString('en',{hour12:false});
    d.textContent = t + ' ' + s + '\n' + d.textContent;
    d.textContent = d.textContent.split('\n').slice(0,30).join('\n');
    console.log(s);
}
function sysMsg(s) {
    const el = document.createElement('div');
    el.className = 'sys'; el.textContent = s;
    const m = document.getElementById('msgs');
    m.appendChild(el); m.scrollTop = m.scrollHeight;
}
function addBubble(text, cls) {
    const ph = document.getElementById('ph');
    if (ph) ph.remove();
    const el = document.createElement('div');
    el.className = 'bubble ' + cls; el.textContent = text;
    const m = document.getElementById('msgs');
    m.appendChild(el); m.scrollTop = m.scrollHeight;
}
function dot(id, state) {
    document.getElementById(id).className = 'dot ' + state;
}
function status(s) { document.getElementById('stText').textContent = s; }

// â”€â”€ quiet.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let transmitter = null;

function startApp() {
    document.getElementById('overlay').remove();
    log('Initializing quiet.js...');
    status('Loading...');

    Quiet.init({
        profilesPrefix: 'https://quiet.github.io/quiet-js/',
        memoryInitializerPrefix: 'https://quiet.github.io/quiet-js/',
        libfecPrefix: 'https://quiet.github.io/quiet-js/'
    });

    Quiet.addReadyCallback(() => {
        log('quiet.js ready!');
        status('Ready âœ“');
        dot('dTx', ''); dot('dRx', '');

        // TX
        transmitter = Quiet.transmitter({
            profile: 'ultrasonic',
            onFinish:  () => { log('TX done'); dot('dTx', ''); },
            onEnqueue: () => { dot('dTx', 'on'); }
        });

        // RX
        Quiet.receiver({
            profile: 'ultrasonic',
            onReceive: (payload) => {
                const text = new TextDecoder().decode(payload);
                log('RX: ' + text);
                dot('dRx', 'on');
                setTimeout(() => dot('dRx', ''), 400);
                addBubble(text, 'received');
            },
            onCreateFail: (reason) => {
                log('RX fail: ' + reason);
                dot('dRx', 'err');
                sysMsg('âš ï¸ Microphone error: ' + reason);
            },
            onReceiveFail: (n) => log('RX decode fail #' + n)
        });

        document.getElementById('txt').disabled = false;
        document.getElementById('txt').placeholder = 'Type a messageâ€¦';
        document.getElementById('btnSend').disabled = false;
        sysMsg('âœ… Ready â€” open on two devices and chat!');

    }, (err) => {
        log('ERROR: ' + err);
        status('Error âœ—');
        dot('dTx','err'); dot('dRx','err');
        sysMsg('âš ï¸ Failed to load quiet.js: ' + err);
    });
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMsg() {
    if (!transmitter) return;
    const txt = document.getElementById('txt');
    const text = txt.value.trim();
    if (!text) return;
    txt.value = '';
    log('TX: ' + text);
    transmitter.transmit(new TextEncoder().encode(text));
    addBubble(text, 'sent');
    dot('dTx', 'busy');
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('txt').addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMsg();
    });
});
</script>
</body>
</html>
